{% extends 'total_index/common.html' %}
{% load static %}
    {% block title %}Twitter用户详细信息采集{% endblock %}
    {% block link %}
    {% endblock %}

    {% block body %}

{#        <div id="Layer1" style="position:absolute; left:0; top:0; width:100%; height:100%">#}
{#        <img src="/static/twitter/twitter_background.jpg" width="100%" height="100%"/>#}
{#        </div>#}

        <div id="wrapper">
            <label><input name="type" type="radio" value="filterTweet" id="filterTweet"/>关键词实时推文</label>
            <label><input name="type" type="radio" value="filterHistoryTweet" id="filterHistoryTweet"/>关键词历史推文</label>
            <p><span style="display:inline-block;width:130px;text-align:right;">推文数据库:</span>
                <select id="selectTweetDatabase" style="width: 248px;background-color: rgba(10, 17, 45, 0.11);">
                    <option selected>选择数据库</option>
                    {% for i in tweet %}
                    <option value={{ i }}>{{ i }}</option>
                    {% endfor %}
                </select>
            </p>
            <p><span style="display:inline-block;width:130px;text-align:right;">关键过滤词:</span><input type="text" id="keywords"></p>
            <button type="button" id='dataCapture'>开始采集</button>
            <button type="button" id='terminate'>结束采集</button>
            <br>
            <br>
            <br>
            <textarea id='result' rows="3" cols="150"></textarea>
            <div id="chart" style="height:400px;"></div>
        <script src="/static/jquery_1.11.1.js"></script>
        <script>
            var processName = null;
            var resultBefore = 0;
            var totalViewNum = 5;
            var dataList = [];
            var len = 300;
            var now = +new Date();
            var internal = 3 * 1000;
            for (var i = 0 ; i < len ; i++)
            {
                dataList.unshift({value:[now,0]});
                now = new Date(+now - internal);
            }
            var timeOut = false;
            var myChart = echarts.init(document.getElementById('chart'));

            $(document).ready(function() {
                $("#dataCapture").click(function () {
                    var selectTweetDatabase = $("#selectTweetDatabase").val();
                    if (selectTweetDatabase == '选择数据库')
                    {
                        alert("请选择推文数据库");
                    }
                    var keywords = $("#keywords").val();
                    var str = document.getElementsByName("type");
                    var type = null;
                    var num = 0;
                    if(str[0].checked == true)
                    {
                          type = str[0].value;
                          num = 1;
                    }else if(str[1].checked == true){
                        type = str[1].value;
                        num = 1;
                    }
                    if(num == 0)
                    {
                        alert("请选择采集类型");
                    }
                    if (selectTweetDatabase != '选择数据库' && num != 0){
                        $.post("/twitter/twitterCapture/", {
                        'selectTweetDatabase': selectTweetDatabase,
                        'type': type,
                        'keywords': keywords
                    }, function (ret) {
                       if (ret['level'] == 'normal'){
                            processName = ret['processName'];
                            $('#result').html(ret['content']);
                            timeOut = false;
                            option = {
                                title: {
                                    text: type,
                                    x:'center',
                                    textStyle: {
                                    fontSize: 18,
                                    fontWeight: 'bolder',
                                    color: '#333'          // 主标题文字颜色
                                }
                                },
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: function (params) {
                                        params = params[0];
                                        var date = new Date();
                                        return params.value[1];
                                    },
                                    axisPointer: {
                                        animation: false
                                    }
                                },

                                xAxis: {
                                    type: 'time',
                                    splitLine: {
                                        show: false
                                    },
                                    name:'时间轴'
                                },
                                yAxis: {
                                    type: 'value',
                                    splitLine: {
                                        show: false
                                    },
                                    name:'采集进程IO速率：bytes/3每秒'
                                },
                                series: [{
                                    name: '模拟数据',
                                    type: 'line',
                                    showSymbol: false,
                                    hoverAnimation: false,
                                    data: dataList
                                }]
                                };
                            myChart.setOption(option);
                            time();
{#                                $("#finishButton").click(function(){#}
{#                                     timeOut = true;#}
{#                                });#}
                       }
                    });
                    }
                });
                $("#checkSchedule").click(function () {
                    var processName = $("#processName").val();
                    $.get("/twitter/twitterCheck/", {
                        'processName': processName,
                    }, function (ret) {
                        $('#result').html(ret)
                    });
                });

                $("#terminate").click(function () {
                    $.get("/twitter/twitterTerminate/", {
                        'processName':processName
                    }, function (ret) {
                        $('#result').html(ret)
                    });
                });
            });
            function time() {
{#                timeOut用于停止循环调用，现在用不到#}
                if(timeOut) return;
                clock();
                setTimeout(time,3000); //time是指本身,延时递归调用自己,100为间隔调用时间,单位毫秒
            }
            function clock(){
                $.get("/twitter/getProcessIO/", {
                        'processName':processName
                    }, function (ret) {
                        if (ret['level'] == 'normal'){
                            dataList.shift();
                            dataList.push({value:[new Date(),ret['data'] - resultBefore]});
                            myChart.setOption({
                            series: [{
                                data: dataList
                            }]
                            });
                            resultBefore = ret['data'];
                        }else{
                            timeOut = true;
                        }

                    });

            }
        </script>
        </div>
    {% endblock %}