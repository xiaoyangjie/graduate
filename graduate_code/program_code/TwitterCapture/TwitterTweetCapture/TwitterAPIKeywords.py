# -*- coding: UTF-8 -*-from TwitterTweetCapture.api.API import APIimport timeimport pymongofrom pymongo.errors import DuplicateKeyErrordef twitterAPIKeywords(proxy=None,keyword=None,mongodb=None,mongoDataName=None,mongoColName=None,                       since_id=None, max_id=None):    """    :param proxy: 代理IP，如："192.168.1.148:8118"    :param keyword: 关键词 ，如kill    :param mongodb: mongodb host    :param mongoDataName: 数据库    :param mongoColName:  集合    :param since_id:  从某个推文ID开始，即起始时间 ，这个需要去网页上找，大约一个范围就行了    :param max_id:   到某个推文ID结束，即结束时间    :return: None    """    #token    token =   {'consumer_key': "fO4lXV6LLz5e1Ew6uRDtvXpIQ",                  'consumer_secret': "LivsS9DTKh4Xmfo2vOG2tpKmrj8lxsYqiDgZLamPBJahFqnjUo",                  'access_token': "713024459158859776-V7r3cttVw77ESAgxl3k4OU6iIsyubbd",                  'access_token_secret': "0oxHNzRbnPM8tDI2IC0HtvmiPV1PFNfi40YuQNQfoskAR"}    api = API(proxy=proxy,token=token)    #数据库集合    client = pymongo.MongoClient(mongodb)[mongoDataName][mongoColName]    flag = False    _i = 1    #采集7天以内的    while True:        try:            #########这个主要是可能因为token、网络等原因导致重新采集，这会使得从开始采集，因此找到已采集的最小ID，从这里开始采集#############            if client.count() != 0 :                max_id = client.find().sort('id')[0]['id']            #################################################            results = api.search_tweet(q=keyword, since_id=since_id,max_id=max_id)            for i in results:                try :                    if i['id'] == _i:                        flag = True                        break                    _i = i['id']                    client.insert_one(i)                except DuplicateKeyError as DKE:                    continue   #这里很重要，不然如果有重复的插入，将会重连，这就造成了，永远不全            if flag:                break        except:            time.sleep(15)if __name__ == '__main__':    keyword = 'church shooting'  # 关键字   (London attack)    (attack)  ()    proxy = '192.168.1.148:8118' #代理    # mongodb = 'mongodb://mongo:123456@222.197.180.150'  # mongodb    mongodb = 'mongodb://kb314:fzdwxxcl.314@121.49.99.14:30011'    mongoDataName = 'event_analysis'  # 数据库名字    mongoColName = 'church_shooting1'  # 集合名字    #注：如果需要爬取特定一段时间的推文，方法1：先使用TwitterWebKeywords采集，然后找到需要时间段的两个ID，方法二：直接在推特网页点击F12查找需要时间段的ID。    since_id = 927222128968536064  #从某个ID开始，如果使用None,表示采集7天以内所有的推文927232128968536064    max_id = 927232128968536064   #到某个ID结束，如果使用None,表示采集7天以内所有的推文    twitterAPIKeywords(proxy=proxy,keyword=keyword,mongodb=mongodb,mongoDataName=mongoDataName,mongoColName=mongoColName,                       since_id=since_id,max_id=max_id)